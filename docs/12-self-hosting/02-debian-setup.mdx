---
toc_max_heading_level: 4
---

# Debian Machine Setup

Steps for manual configuration and provisioning of Debian 12 server systems. These steps will also
upgrade a Debain 11 system to Debian 12. This guide assumes and recommends that the user is starting
from a fresh installation. If you unfamiliar with the installation process for Debian, see the links
below before progressing.

- [How to Install Debian](https://www.linuxtechi.com/how-to-install-debian-11-bullseye/)

- [Debian 12 ISO Image](https://cdimage.debian.org/cdimage/weekly-builds/amd64/iso-dvd/debian-testing-amd64-DVD-1.iso)

## Base Setup

1. Update the apt sources to include the required branches

```bash
cat << EOF > /etc/apt/sources.list
deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
deb-src http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware

deb http://deb.debian.org/debian-security/ bookworm-security main contrib non-free
deb-src http://deb.debian.org/debian-security/ bookworm-security main contrib non-free

deb http://deb.debian.org/debian bookworm-updates main contrib non-free
deb-src http://deb.debian.org/debian bookworm-updates main contrib non-free
EOF
```

2. Apply system updates and upgrades

Update the package list and upgrade system components prior to installing other software. Reboot
after the process completes.

```bash
sudo apt-get update && \
sudo apt-get upgrade -y && \
sudo apt-get full-upgrade -y

sudo reboot
```

2. Install base utilities

Installing a small set of base packages that are dependancies for steps later in the guide and
helpful in general.

```bash
sudo apt-get update && \
  sudo apt-get install -y \
  ssh-import-id \
  sudo \
  curl \
  jq \
  htop \
  netplan.io \
  apt-transport-https \
  ca-certificates \
  software-properties-common \
  git-extras \
  rsyslog \
  fail2ban \
  vim \
  gpg
```

Install `yq`. It's `jq` but for yaml.

```bash
sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq &&\
sudo chmod +x /usr/bin/yq
```

3. Install Docker

   - Download the docker gpg key

     ```bash
     curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
     sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
     ```

   - Add the apt package source

     ```bash
     echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
     ```

   - Update the apt package list and install Docker

     ```bash
     sudo apt-get update && sudo apt-get install -y docker-ce
     ```

4. Setup a non-root user

   - Create the user

     ```bash
     export NEW_USER="<some new user here>"
     sudo useradd -s /bin/bash -d /home/$NEW_USER/ -m -G sudo $NEW_USER
     ```

   - Grant passwordless sudo permission

     ```bash
     sudo echo "$NEW_USER ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
     ```

   - Import an ssh key

     ```bash
     sudo -u friend ssh-import-id-gh cloudymax
     ```

   - Add the user to relevant groups

     ```bash
     sudo usermod -a -G kvm $NEW_USER
     sudo usermod -a -G docker $NEW_USER
     ```

   - Craete a password for the user

     ```bash
     passwd $NEW_USER
     ```

## Docker Compose

The default Ubuntu package lists provide a very outdated version of docker compose. Below are the
steps required to install a current version.

1. Find the latest version by visiting https://github.com/docker/compose/releases

```bash
export COMPOSE_VERSION="2.17.3/"
```

2. Create a directory for the binary

```bash
mkdir -p ~/.docker/cli-plugins/
```

3. Download the binary

```bash
curl -SL https://github.com/docker/compose/releases/download/v$COMPOSE_VERSION/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose
```

4. Make it executable

```bash
chmod +x ~/.docker/cli-plugins/docker-compose
```

## NVIDIA GPU Drivers

Debain's built-in driver installation process is more reliable than Ubuntu's, but readers are
advised to get their driver installaer directly from NVIDIA

### Install from apt

```bash
apt-get install -y nvidia-driver \
firmware-misc-nonfree \
linux-headers-amd64 \
gcc \
linux-headers-`uname -r`
```

### Install from Nvidia

1. Download and install driver dependancies

```bash
sudo apt-get install -y gcc \
linux-headers-`uname -r` \
linux-headers-amd64 \
firmware-misc-nonfree
```

2. Find your driver version and download the installer

   - Use Nvidia's web tool located here: https://www.nvidia.com/download/index.aspx.

   - Alternatively, you can download a specific driver version using curl

     ```bash
     export DRIVER_VERSION=""

     # GeForce Cards
     curl --progress-bar -fL -O "https://us.download.nvidia.com/XFree86/Linux-x86_64/$DRIVER_VERSION/NVIDIA-Linux-x86_64-$DRIVER_VERSION.run"

     # Datacenter Cards
     curl --progress-bar -fL -O "https://us.download.nvidia.com/tesla/$DRIVER_VERSION/NVIDIA-Linux-x86_64-$DRIVER_VERSION.run"
     ```

3. Run the Installer

   - It is required to run the driver from the system console, it cannot be installed from an X
     session.

     ```bash
     sudo bash "NVIDIA-Linux-x86_64-*.run"
     ```

## Nvidia Container Toolkit

The nvidia container toolkit allows containes to access the GPU resources of the underlying host
machine. Requires that the GPU drivers are already installed on the host. See the official docs
here: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html

1. Set your system distribution name to debian11

```bash
distribution=debian11
```

2. Download the gpg key and add the repo to your apt sources

```bash
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
&& curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
```

3. Update apt packages and install the container toolkit

```bash
sudo apt-get update && sudo apt-get install -y nvidia-container-toolkit
```

4. Set `nvidia` the default container runtime

```bash
sudo nvidia-ctk runtime configure --runtime=docker --set-as-default
```

5. Restart the docker service

```bash
sudo systemctl restart docker
```

6. Test that it is working

```bash
sudo docker run --rm --runtime=nvidia --gpus all nvidia/cuda:11.6.2-base-ubuntu20.04 nvidia-smi
```
