import Vnc from '/assets/images/vnc-connection.png';
import Virtio from '/assets/images/win10-virtio-drivers.png';
import BootFromCd from '/assets/images/boot-from-cd.png';
import RDP from '/assets/images/win10-rdp.png';
import Install from '/assets/images/win10-install.png';
import Lang from '/assets/images/win10-language.png';
import Serial from '/assets/images/win10-serial.png';
import Version from '/assets/images/win10-version.png';
import Eula from '/assets/images/win10-eula.png';
import CustomInstall from '/assets/images/win10-custom-install.png';
import DiskSelect from '/assets/images/win10-disk-select.png';
import DriverBrowse from '/assets/images/win10-driver-browse.png';
import InstallDriver from '/assets/images/win10-install-driver.png';
import VirtioDisk from '/assets/images/win10-driver-disk.png';
import Viostor from '/assets/images/win10-viostor.png';
import VirtioGpu from '/assets/images/win10-virtiogpu.png';
import NetKvm from '/assets/images/win10-netkvm.png';
import FormatDisk from '/assets/images/win10-format-disk.png';
import Partition from '/assets/images/win10-partitions.png';
import Installing from '/assets/images/win10-installing.png';

# Windows

With the use of KVM, QEMU is capable of creating Windows guests with near-native performance.

## Setup

### 1. Configure the Virtual Machine options

```bash
# The name of the Virtual Machine
export VM_NAME="gameci"

# Number of physical CPU cores to allocate to the VM
export PHYSICAL_CORES="2"

# Number of threads per core.
# Set this to `1` for CPUs that do not support hyper-threading
export THREADS="1"
export SMP=$(( $PHYSICAL_CORES * $THREADS ))

# Amount of Disk Space to allocate to the VM.
# Cannot exceed available on host.
export DISK_SIZE="32G"

# Amount of RAM to allocate to the VM.
# Cannot exceed available RAM on host.
export MEMORY="8G"

# IP address where host may be reached. Do not use `localhost`.
export HOST_ADDRESS="SOME IP HERE"

# Port number to expose on the host for VNC
export VNC_PORT="0"
```

### 2. Select a Windows ISO

```yaml
Windows:
  Windows10: 'https://www.itechtics.com/?dl_id=173'
  server2019-core: 'https://go.microsoft.com/fwlink/p/?LinkID=2195167&clcid=0x409&culture=en-us&country=US'
  Tiny10: https://ia902609.us.archive.org/27/items/tiny-10-NTDEV/tiny10%2023h1%20x64.iso
  Tiny11: https://ia800509.us.archive.org/27/items/tiny11-23h2/tiny11%2023H2%20x64.iso
```

### 3. Download an installer

```bash
export IMAGE_URL="SOME_URL_HERE"
export IMAGE_NAME=windows.iso
wget -c -O "$IMAGE_NAME" "$IMAGE_URL" -q --show-progress
```

### 4. Download virtual-disk drivers

```bash
wget -O "virtio-drivers.iso" "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.240-1/virtio-win-0.1.240.iso"
```

### 5. Create the virtual disk

```bash
qemu-img create -f qcow2 disk.qcow2 $DISK_SIZE &>/dev/null
```

## Create the VM

### Create new guest:

```bash
sudo qemu-system-x86_64 \
  -machine accel=kvm,type=q35 \
  -cpu host,kvm="off",hv_vendor_id="null" \
  -smp $SMP,sockets=1,cores="$PHYSICAL_CORES",threads="$THREADS",maxcpus=$SMP \
  -m "$MEMORY" \
  -drive id=disk0,if=virtio,cache=none,format=qcow2,file=disk.qcow2 \
  -drive file=windows.iso,index=1,media=cdrom \
  -drive file=virtio-drivers.iso,index=2,media=cdrom \
  -boot menu=on \
  -bios /usr/share/ovmf/OVMF.fd \
  -usbdevice tablet \
  -serial stdio -vga virtio -parallel none \
  -device virtio-net-pci,netdev=network \
  -netdev user,id=network,hostfwd=tcp::3389-:3389 \
  -vnc $HOST_ADDRESS:$VNC_PORT
```

### Boot existing guest:

```bash
sudo qemu-system-x86_64 \
  -machine accel=kvm,type=q35 \
  -cpu host,kvm="off",hv_vendor_id="null",check="off",hypervisor="off" \
  -smp $SMP,sockets=1,cores="$PHYSICAL_CORES",threads="$THREADS",maxcpus=$SMP \
  -m "$MEMORY" \
  -object iothread,id=io \
  -device virtio-blk-pci,drive=disk,iothread=io \
  -drive if=none,id=disk,cache=none,format=qcow2,aio=threads,file=disk.qcow2 \
  -drive file=virtio-drivers.iso,index=2,media=cdrom \
  -boot menu=on \
  -serial none \
  -parallel none \
  -bios /usr/share/ovmf/OVMF.fd \
  -usbdevice tablet \
  -serial stdio -vga virtio -parallel none \
  -device virtio-net-pci,netdev=network \
  -netdev user,id=network,hostfwd=tcp::3389-:3389 \
  -vnc $HOST_ADDRESS:$VNC_PORT
```

## Boot from CD

Press any key to boot from the Live-ISO when prompted, then connect to the VM over VNC.

> Some ISO images (like tiny11 and tiny10) will require you to quickly open a VNC connection to
> provide the key-press input or they will skip the boot option and you will need to restart the VM
> to try again.

<div style={{ textAlign: 'center' }}>
  <img src={BootFromCd} width="600" />
</div>
<br />
<br />

### Connect to the VM using VNC

- In your VNC software use the address format `$HOST_ADDRESS:$VNC_PORT` to connect to the VM.

<div style={{ textAlign: 'center' }}>
  <img src={Vnc} width="600" />
</div>
<br />
<br />

## Install Windows

### 1. Select 'Install now'

<div style={{ textAlign: 'center' }}>
  <img src={Install} width="600" />
</div>
<br />
<br />

### 2. Set language and region

<div style={{ textAlign: 'center' }}>
  <img src={Lang} width="600" />
</div>
<br />
<br />

### 3. Product Key

Enter your key or select "I don't have a product key" to skip.

<div style={{ textAlign: 'center' }}>
  <img src={Serial} width="600" />
</div>
<br />
<br />

### 4. Select Version

Choose a windows version to install, using a 'Pro' version is advised.

<div style={{ textAlign: 'center' }}>
  <img src={Version} width="600" />
</div>
<br />
<br />

### 5. Accept the EULA

<div style={{ textAlign: 'center' }}>
  <img src={Eula} width="600" />
</div>
<br />
<br />

### 6. Select 'Custom Install'

<div style={{ textAlign: 'center' }}>
  <img src={CustomInstall} width="600" />
</div>
<br />
<br />

### 7. Install Drivers

You should now see the disck selection screen without any available disk. This is because Windows
cannot use the virtio disk we have created without adding drivers during the installation process.

<div style={{ textAlign: 'center' }}>
  <img src={DiskSelect} width="600" />
</div>
<br />
<br />

To install the required drivers, select the 'Load Driver' button, then select 'Browse' to open a
file-explorer from which to choose the install media.

<div style={{ textAlign: 'center' }}>
  <img src={DriverBrowse} width="600" />
</div>
<br />
<br />

The drivers are located in disk drive 'E' which should be named 'virtio-win-[version]'

<div style={{ textAlign: 'center' }}>
  <img src={VirtioDisk} width="400" />
</div>
<br />
<br />

#### Viostor (Required)

Find and select the 'Viostor' directory, then choose the directory that corresponds to your
operating system version. Choose the 'amd64' directory inside and click 'OK'.

<div style={{ textAlign: 'center' }}>
  <img src={Viostor} width="400" />
</div>
<br />
<br />

Click 'Next' on the following screen to install the driver.

<div style={{ textAlign: 'center' }}>
  <img src={InstallDriver} width="600" />
</div>
<br />
<br />

#### NetKvm (Required)

Repeat the same process from above to find and install the NetKVM driver

<div style={{ textAlign: 'center' }}>
  <img src={NetKvm} width="400" />
</div>
<br />
<br />

#### Viogpudo (Optional)

This driver will add more screen resolution options to the VNC display. The installation process is
the same as the previous drivers.

<div style={{ textAlign: 'center' }}>
  <img src={VirtioGpu} width="400" />
</div>
<br />
<br />

### 8. Format and Partition Disk

With the drivers installed, we are now able to format and partition our virtual disk. Select 'Drive
0' then click 'new'.

<div style={{ textAlign: 'center' }}>
  <img src={FormatDisk} width="600" />
</div>
<br />
<br />

Select largest of the newly-created partitions, then click 'Next'.

<div style={{ textAlign: 'center' }}>
  <img src={Partition} width="600" />
</div>
<br />
<br />

The install process should now begin. From this point you may simply follow the directions
on-screen. When the system reboots, allow the 'Press any key to boot from CD' prompt to time-out.
This avoids restarting the setup process.

<div style={{ textAlign: 'center' }}>
  <img src={Installing} width="600" />
</div>
<br />
<br />

### Enable RDP (Optional)

If you would like a more performant remote desktop, consider using RDP instead of VNC. The required
port for VNC `3389` is already forwarded in the commands above, the guide below will guide you
through enabling RDP.

- https://www.helpwire.app/blog/how-to-allow-rdp-windows-10/

You will also need an RDP client to access the VM. See the official Microsoft recommended clients
list here:
https://learn.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-clients

### Connect to the VM using RDP (Optional)

To connect to the VM with your RDP client, use the host's IP address as the 'PC Name'.

<div style={{ textAlign: 'center' }}>
  <img src={RDP} width="400" />
</div>
<br />
<br />
